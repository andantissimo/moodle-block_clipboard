define(["jquery","jqueryui","core/yui","core/ajax","core/templates","core/notification"],function(a,b,c,d,e,f){function g(a,b){return d.call([{methodname:a,args:b||{}}])[0]}function h(a){return 0!==u.find('[data-cmid="'+a+'"]').length}function i(){if(!w){var a=M.util.add_spinner(c,c.Node(t[0]));a.show(),w=g("block_clipboard_get_tree").then(function(a){return e.render("block_clipboard/content",{config:M.cfg,courses:a.courses})}).then(function(b){u.html(b),l(),n(),o(),w=null,a.hide()})["catch"](function(b){a.hide(),f.exception(b)})}return w}function j(b,d){var e=M.util.add_lightbox(c,c.one(b.target)),f={courseid:r,section:+/^section-(\d+)$/.exec(b.target.id)[1],cmid:+d.draggable.attr("data-cmid")};g("block_clipboard_paste",f).then(function(f){var g=c.Node.create(f.fullcontent);c.one(b.target).one("ul.section").appendChild(g),c.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource",g)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(g),d.draggable.css({left:0,top:0}),e.hide(),a(b.target).find("ul.section li.activity").each(function(){k(a(this))})})["catch"](function(){d.draggable.css({left:0,top:0}),e.hide()}),e.show()}function k(b){if(v.capabilities.backup&&b.length&&b.attr("id")){var c=+b.attr("id").match(/^module-(\d+)$/)[1],d=b.find(".section-cm-edit-actions"),e=d.find('[data-action="copytoclipboard"]');if(!e.length){e=a(v.actions.copytoclipboard.replace(/<a href="([^"]*)"/,function(a,b){return'<a href="'+b+"?sesskey="+M.cfg.sesskey+"&copy="+c+'"'}));var f=d.find('[data-action="duplicate"]');f.hasClass("dropdown-item")&&e.addClass("dropdown-item"),e.insertAfter(f)}h(c)?e.addClass("disabled"):e.removeClass("disabled")}}function l(){v.capabilities.backup&&a("ul.section li.activity").each(function(){k(a(this))})}function m(){v.capabilities.restore&&a("li.section").droppable({accept:".type_activity",hoverClass:"highlight",drop:j})}function n(){a("li.section").droppable("instance")&&u.find(".type_activity").draggable({revert:"invalid"})}function o(){u.find('[data-action="delete"]').on("click",function(b){b.preventDefault();var c=a(this).closest("[data-cmid]"),d=c.attr("data-cmid");g("block_clipboard_delete",{cmid:d}),c.remove();var e=a("#module-"+d);e.find('[data-action="copytoclipboard"]').removeClass("disabled")})}function p(){var b=!1,c=document.documentElement,d={capture:!0,passive:!0};c.addEventListener("mousedown",function(){b=!0},d),c.addEventListener("mouseup",function(){b=!1},d);var e=new MutationObserver(function(c){b||c.some(function(b){if(b.target.classList&&b.target.classList.contains("editing_move")&&b.target.classList.contains("moodle-core-dragdrop-draghandle")){var c=a(b.target).closest("li.activity");return h(c.attr("id").match(/^module-(\d+)$/)[1])?i():l(),!0}return Array.prototype.some.call(b.addedNodes,function(a){return!(!a.classList||!a.classList.contains("section_add_menus")||0!==b.removedNodes.length)&&(m(),i(),!0)})||Array.prototype.some.call(b.removedNodes,function(a){return a.classList&&a.classList.contains("updating")&&"activityname"===a.getAttribute("data-itemtype")?(h(a.getAttribute("data-itemid"))&&i(),!0):!!/^module-(\d+)$/.test(a.id)&&(h(RegExp.$1)&&i(),!0)})})});e.observe(document.querySelector(".course-content"),{childList:!0,subtree:!0})}function q(b,d){v={capabilities:b,actions:d},l(),m(),a("body").on("click keypress",'li.activity a.cm-edit-action[data-action="copytoclipboard"]',function(b){if("keypress"!==b.type||13===b.keyCode){var d=a(this),e=d.closest("li.activity"),h=e.attr("id").match(/^module-(\d+)$/)[1];if(b.preventDefault(),!d.hasClass("disabled")){var j=M.util.add_spinner(c,c.Node(e.find(".actions")[0]));j.show(),g("block_clipboard_copy",{cmid:h}).then(i).then(function(){j.hide()})["catch"](function(a){j.hide(),f.exception(a)})}}}),i().then(function(){p()})["catch"](f.exception)}var r=+a.map(document.body.classList,function(a){return/^course-(\d+)$/.exec(a)})[1],s=a(".block_clipboard"),t=s.find("#"+s.attr("aria-labelledby")),u=s.find(".content"),v={capabilities:{backup:!1,restore:!1},actions:{copytoclipboard:""}},w=null;return{setup:q}});