define(["jquery","jqueryui","core/yui","core/ajax","core/templates","core/notification"],function(a,b,c,d,e,f){function g(a,b){return d.call([{methodname:a,args:b||{}}])[0]}function h(a,b){var d=n.util.add_lightbox(c,c.one(a.target)),e={courseid:o,section:+a.target.id.match(/(\d+)$/)[1],cmid:+b.draggable.attr("class").match(/starred-(\d+)/)[1]};g("block_favorites_duplicate",e).then(function(e){var f=c.Node.create(e.fullcontent);c.one(a.target).one("ul.section").appendChild(f),c.use("moodle-course-coursebase",function(){n.course.coursebase.invoke_function("setup_for_resource",f)}),n.core.actionmenu&&n.core.actionmenu.newDOMNode&&n.core.actionmenu.newDOMNode(f),b.draggable.css({left:0,top:0}),d.hide()})["catch"](function(){b.draggable.css({left:0,top:0}),d.hide()}),d.show()}function i(){a("li.section").droppable({accept:".type_activity",hoverClass:"highlight",drop:h})}function j(){p.find(".type_activity").draggable({revert:"invalid"})}function k(){g("block_favorites_get_tree").then(function(a){return e.render("block_favorites/content",a)}).then(function(a){p.html(a),j()})["catch"](f.exception)}function l(){var a=+this.id.match(/(\d+)$/)[1],b=!this.classList.contains("starred");g("block_favorites_star",{cmid:a,starred:b}).then(function(){this.classList[b?"add":"remove"]("starred"),k()}.bind(this))["catch"](f.exception)}function m(b){if(b.length&&b.attr("id")){var c=+b.attr("id").match(/(\d+)$/)[1];if(!b.find(".block_favorites-icon").length){var d=a('<div class="block_favorites-icon"/>');d.attr("id","block_favorites-icon-"+c),p.find(".starred-"+c).length&&d.addClass("starred"),d.on("click",l),b.prepend(d)}}}var n=window.M,o=+a("body").attr("class").match(/course-(\d+)/)[1],p=a(".block_favorites .content");return{setup:function(){i(),j(),a("ul.section li.activity").each(function(){m(a(this))});var b=new MutationObserver(function(b){b.some(function(b){return b.target.classList&&b.target.classList.contains("moodle-core-dragdrop-draghandle")?(m(a(b.target).closest("li.activity")),k(),!0):Array.prototype.some.call(b.addedNodes,function(a){return!(!a.classList||!a.classList.contains("section_add_menus")||0!==b.removedNodes.length)&&(k(),!0)})||Array.prototype.some.call(b.removedNodes,function(a){return a.classList&&a.classList.contains("updating")&&"activityname"===a.getAttribute("data-itemtype")?(k(),!0):!!/^module-\d+$/.test(a.id)&&(k(),!0)})})});b.observe(document.querySelector(".course-content"),{childList:!0,subtree:!0})}}});