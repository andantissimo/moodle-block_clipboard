define(["jquery","jqueryui","core/yui","core/ajax","core/templates","core/notification"],function(a,b,c,d,e,f){function g(a,b){return d.call([{methodname:a,args:b||{}}])[0]}function h(a,b){var d=M.util.add_lightbox(c,c.one(a.target)),e={courseid:o,section:+/^section-(\d+)$/.exec(a.target.id)[1],cmid:+b.draggable.attr("data-cmid")};g("block_favorites_duplicate",e).then(function(e){var f=c.Node.create(e.fullcontent);c.one(a.target).one("ul.section").appendChild(f),c.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource",f)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(f),b.draggable.css({left:0,top:0}),d.hide()})["catch"](function(){b.draggable.css({left:0,top:0}),d.hide()}),d.show()}function i(){a("li.section").droppable({accept:".type_activity",hoverClass:"highlight",drop:h})}function j(){a("li.section").droppable("instance")&&p.find(".type_activity").draggable({revert:"invalid"})}function k(){g("block_favorites_get_tree").then(function(a){return e.render("block_favorites/content",{config:M.cfg,courses:a.courses})}).then(function(a){p.html(a),j()})["catch"](f.exception)}function l(){var a=+this.getAttribute("data-cmid"),b=!this.classList.contains("starred");g("block_favorites_star",{cmid:a,starred:b}).then(function(){this.classList[b?"add":"remove"]("starred"),k()}.bind(this))["catch"](f.exception)}function m(b){if(b.length&&b.attr("id")&&!b.find(".block_favorites_icon").length){var c=+b.attr("id").match(/^module-(\d+)$/)[1],d=a('<div class="block_favorites_icon"/>');d.attr("data-cmid",c),p.find("[data-cmid="+c+"]").length&&d.addClass("starred"),d.on("click",l),b.prepend(d)}}function n(b){b.restore&&(i(),j()),b.backup&&a("ul.section li.activity").each(function(){m(a(this))});var c=!1;document.documentElement.addEventListener("mousedown",function(){c=!0},{capture:!0,passive:!0}),document.documentElement.addEventListener("mouseup",function(){c=!1},{capture:!0,passive:!0});var d=new MutationObserver(function(d){c||d.some(function(c){return c.target.classList&&c.target.classList.contains("editing_move")&&c.target.classList.contains("moodle-core-dragdrop-draghandle")?(b.backup&&m(a(c.target).closest("li.activity")),k(),!0):Array.prototype.some.call(c.addedNodes,function(a){return!(!a.classList||!a.classList.contains("section_add_menus")||0!==c.removedNodes.length)&&(k(),!0)})||Array.prototype.some.call(c.removedNodes,function(a){return a.classList&&a.classList.contains("updating")&&"activityname"===a.getAttribute("data-itemtype")?(k(),!0):!!/^module-\d+$/.test(a.id)&&(k(),!0)})})});setTimeout(function(){d.observe(document.querySelector(".course-content"),{childList:!0,subtree:!0})},1e3)}var o=+a.map(document.body.classList,function(a){return/^course-(\d+)$/.exec(a)})[1],p=a(".block_favorites .content");return{setup:n}});